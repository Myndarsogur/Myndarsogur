<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="utf-8" />
  <title>Tímarit – snertilesari</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <style>
    :root { --anim-ms: 280ms; }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #fff;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      touch-action: none; /* við tökum yfir snertingu */
      overscroll-behavior: contain;
    }
    /* Aðalsvæði – fyllir skjá, virðir "notch" öruggs svæði */
    #viewer {
      position: fixed;
      inset: 0;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      height: 100dvh;
      background: #000;
      overflow: hidden;
      display: grid;
      place-items: center;
      touch-action: none; /* pointer events fyrir pinch/pan */
    }

    /* Tvö lög til að ná snyrtilegri síðu-anim */
    .layer {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      will-change: transform, opacity;
      contain: paint;
      pointer-events: none; /* við hlustum bara á #viewer */
      transform: translate3d(0,0,0);
    }
    /* Myndin sjálf – fyllir sem mest án skekkju */
    .page {
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: 100%;
      object-fit: contain;
      backface-visibility: hidden;
      transform: translate3d(0,0,0) scale(1);
      will-change: transform;
      image-rendering: auto;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    /* Fletti-anim (sleek slide), virkt bara við síðuaskipti */
    .slide-in-next   { transform: translateX(100%); }
    .slide-in-prev   { transform: translateX(-100%); }
    .slide-in-active { transition: transform var(--anim-ms) ease; transform: translateX(0%); }

    .slide-out-next   { transform: translateX(0%); }
    .slide-out-prev   { transform: translateX(0%); }
    .slide-out-active-next { transition: transform var(--anim-ms) ease, opacity var(--anim-ms) ease; transform: translateX(-30%); opacity: .6; }
    .slide-out-active-prev { transition: transform var(--anim-ms) ease, opacity var(--anim-ms) ease; transform: translateX(30%);  opacity: .6; }

    /* Virða stillingu notanda */
    @media (prefers-reduced-motion: reduce) {
      :root { --anim-ms: 0ms; }
    }

    /* Aðgengis-uppf: falin en lestrartæki sjá */
    .sr-only {
      position: absolute !important;
      width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,1px,1px); white-space: nowrap; border: 0;
    }
  </style>
</head>
<body>
  <main id="viewer" aria-label="Tímarit" role="main">
    <div id="layerA" class="layer"></div>
    <div id="layerB" class="layer" hidden></div>
    <div aria-live="polite" class="sr-only" id="status"></div>
  </main>

  <script>
    /* =======================
       STILLINGAR – AÐLAGA ÞÚ
       ======================= */
    const TOTAL_PAGES = 24; // <- breyttu mér
    const IMAGE_PATH = i => `/pages/${String(i).padStart(3,'0')}.jpg`; // 001.jpg, 002.jpg, ...

    /* =======================
       INNVIÐIR
       ======================= */
    const viewer  = document.getElementById('viewer');
    const layerA  = document.getElementById('layerA');
    const layerB  = document.getElementById('layerB');
    const status  = document.getElementById('status');

    let currentLayer = layerA;
    let backLayer    = layerB;

    let pageIndex = 1;

    // Sýnilegur "hlutur" sem við zoom-um/pönnum: img innan active layer
    let imgEl = null;

    // Snertistig
    const pointers = new Map(); // id -> {x,y}
    let startMid = null, startDist = 0, startScale = 1, startTx = 0, startTy = 0;
    let scale = 1, tx = 0, ty = 0;

    // Fyrir swipe
    let oneStart = null; // {x,y,t}

    // Hraðari teikning
    let rafPending = false;

    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

    function setTransform() {
      if (!imgEl) return;
      imgEl.style.transform = `translate3d(${tx}px, ${ty}px, 0px) scale(${scale})`;
    }

    function scheduleDraw() {
      if (rafPending) return;
      rafPending = true;
      requestAnimationFrame(() => { setTransform(); rafPending = false; });
    }

    function resetTransform(animateBack=false) {
      scale = 1; tx = 0; ty = 0;
      if (!imgEl) return;
      if (animateBack) {
        imgEl.style.transition = 'transform 180ms ease';
        setTransform();
        imgEl.addEventListener('transitionend', () => { imgEl.style.transition = 'none'; }, { once: true });
      } else {
        imgEl.style.transition = 'none';
        setTransform();
      }
    }

    function containerSize() {
      const r = viewer.getBoundingClientRect();
      return { w: r.width, h: r.height };
    }

    function clampPan() {
      // Einföld pan-takmörk miðað við skjástærð – „nóg gott“ fyrir clean upplifun
      const { w, h } = containerSize();
      const maxX = (w * (scale - 1)) / 2;
      const maxY = (h * (scale - 1)) / 2;
      tx = clamp(tx, -maxX, maxX);
      ty = clamp(ty, -maxY, maxY);
    }

    function loadInto(layer, index, onload) {
      layer.innerHTML = '';
      const img = new Image();
      img.decoding = 'async';
      img.loading  = 'eager';
      img.alt = `Síða ${index} af ${TOTAL_PAGES}`;
      img.className = 'page';
      img.src = IMAGE_PATH(index);
      img.addEventListener('load', () => onload && onload(img), { once: true });
      layer.appendChild(img);
    }

    function announce(msg) { status.textContent = msg; }

    function preloadNeighbors(i) {
      const next = i + 1 <= TOTAL_PAGES ? IMAGE_PATH(i+1) : null;
      const prev = i - 1 >= 1 ? IMAGE_PATH(i-1) : null;
      [next, prev].filter(Boolean).forEach(src => { const im = new Image(); im.src = src; });
    }

    function showPage(index, direction = null) {
      index = clamp(index, 1, TOTAL_PAGES);
      if (index === pageIndex && !direction) return;

      const oldLayer = currentLayer;
      const newLayer = backLayer;
      newLayer.hidden = false;

      loadInto(newLayer, index, (newImg) => {
        // undirbúningur
        // ný mynd verður virka „canvas-ið“
        imgEl = newImg;
        resetTransform(false);

        // animation classes
        const enterClass = direction === 'next' ? 'slide-in-next' : direction === 'prev' ? 'slide-in-prev' : '';
        const exitActive = direction === 'next' ? 'slide-out-active-next' : direction === 'prev' ? 'slide-out-active-prev' : '';

        if (direction) {
          newLayer.classList.add(enterClass);
          // Force reflow
          newLayer.getBoundingClientRect();
          newLayer.classList.add('slide-in-active');
          oldLayer.classList.add(direction === 'next' ? 'slide-out-next' : 'slide-out-prev', exitActive);
        }

        const finalize = () => {
          // hreinsa klasa og skipta á lögum
          oldLayer.className = 'layer';
          newLayer.className = 'layer';
          oldLayer.hidden = true;

          // víxla
          [currentLayer, backLayer] = [newLayer, oldLayer];

          pageIndex = index;
          announce(`Síða ${pageIndex} af ${TOTAL_PAGES}`);
          preloadNeighbors(pageIndex);
        };

        if (direction) {
          const onEnd = (ev) => {
            if (ev.target !== newLayer) return;
            newLayer.removeEventListener('transitionend', onEnd);
            finalize();
          };
          newLayer.addEventListener('transitionend', onEnd);
        } else {
          finalize();
        }
      });
    }

    // Fyrsta hleðsla
    showPage(pageIndex);

    /* =======================
       GESTURES
       ======================= */
    viewer.addEventListener('pointerdown', (e) => {
      viewer.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      if (pointers.size === 1) {
        oneStart = { x: e.clientX, y: e.clientY, t: performance.now() };
      }

      if (pointers.size === 2) {
        // init pinch
        const pts = Array.from(pointers.values());
        startDist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
        startMid  = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 };
        startScale = scale;
        startTx = tx; startTy = ty;
      }
    }, { passive: true });

    viewer.addEventListener('pointermove', (e) => {
      if (!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

      // PINCH-ZOOM
      if (pointers.size === 2) {
        e.preventDefault();
        const pts = Array.from(pointers.values());
        const dist = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
        if (startDist > 0) {
          const raw = startScale * (dist / startDist);
          const newScale = clamp(raw, 1, 4);
          // halda miðpunkti stöðugum
          const cx = startMid.x;
          const cy = startMid.y;
          // punktur í „innihaldi“ sem var undir miðju í upphafi
          const contentX = (cx - startTx) / startScale;
          const contentY = (cy - startTy) / startScale;

          scale = newScale;
          tx = cx - contentX * scale;
          ty = cy - contentY * scale;

          clampPan();
          scheduleDraw();
        }
        return;
      }

      // ONE-FINGER – PAN ef zoomað, annars leyfum „swipe“ á pointerup
      if (pointers.size === 1 && scale > 1.01) {
        e.preventDefault();
        const p = pointers.get(e.pointerId);
        const dx = p.x - oneStart.x;
        const dy = p.y - oneStart.y;
        tx = startTx + dx;
        ty = startTy + dy;
        clampPan();
        scheduleDraw();
      }
    }, { passive: false });

    function clearPointer(e) {
      if (!pointers.has(e.pointerId)) return;
      pointers.delete(e.pointerId);

      // Enda pinch
      if (pointers.size < 2) {
        startDist = 0; startMid = null;
        startScale = scale; startTx = tx; startTy = ty;
      }

      // ONE-FINGER swipe detection
      if (pointers.size === 0 && oneStart) {
        const dx = e.clientX - oneStart.x;
        const dy = e.clientY - oneStart.y;
        const dt = performance.now() - oneStart.t;
        oneStart = null;

        // Ef ekki zoomað, túlka sem blaðsíðuflettingu
        if (scale <= 1.03) {
          const horiz = Math.abs(dx) > 60 && Math.abs(dy) < 80;
          const quick = dt < 500;
          if (horiz && quick) {
            if (dx < 0 && pageIndex < TOTAL_PAGES) {
              showPage(pageIndex + 1, 'next');
              return;
            } else if (dx > 0 && pageIndex > 1) {
              showPage(pageIndex - 1, 'prev');
              return;
            }
          }
          // ef lítil hreyfing – ekkert
        } else {
          // ef zoomað og lítil hreyfing – smá snap til baka innan marka
          clampPan();
          scheduleDraw();
        }
      }
    }

    ['pointerup','pointercancel','pointerleave'].forEach(type => {
      viewer.addEventListener(type, clearPointer, { passive: true });
    });

    // Tvöfalt pikki = toggla hrað-zoom (valkvætt, engin sýnileg stjórntæki)
    let lastTap = 0;
    viewer.addEventListener('pointerdown', (e) => {
      const now = performance.now();
      if (now - lastTap < 280 && pointers.size === 1) {
        // double tap
        if (scale > 1.01) {
          resetTransform(true);
        } else {
          // zoom-a hraðað inn að snertipunkti
          const targetScale = 2;
          const cx = e.clientX, cy = e.clientY;
          const contentX = (cx - tx) / scale;
          const contentY = (cy - ty) / scale;
          scale = targetScale;
          tx = cx - contentX * scale;
          ty = cy - contentY * scale;
          clampPan();
          imgEl.style.transition = 'transform 180ms ease';
          setTransform();
          imgEl.addEventListener('transitionend', () => { imgEl.style.transition = 'none'; }, { once: true });
        }
      }
      lastTap = now;
    }, { passive: true });

    // Lyklaborð (fyrir tölvupróf)
    window.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === 'PageDown') {
        if (pageIndex < TOTAL_PAGES && scale <= 1.03) showPage(pageIndex + 1, 'next');
      } else if (e.key === 'ArrowLeft' || e.key === 'PageUp') {
        if (pageIndex > 1 && scale <= 1.03) showPage(pageIndex - 1, 'prev');
      } else if (e.key === 'Escape') {
        resetTransform(true);
      }
    });

    // Forða okkur frá back-swipe í vafra að mestu (ekki 100% á iOS)
    document.addEventListener('gesturestart', (e) => e.preventDefault());

    // Halda utan um pan-byrjun þegar zoomað er
    viewer.addEventListener('pointerdown', (e) => {
      if (scale > 1.01) {
        startTx = tx; startTy = ty;
      }
    }, { passive: true });

    // Uppfæra status fyrst
    announce(`Síða ${pageIndex} af ${TOTAL_PAGES}`);
  </script>
</body>
</html>