<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>√ûj√≥fsaga</title>
  <style>
    :root {
      --bg: #b1d7ff;
      --ground: #7a5530;
      --player: #22d3ee;
      --box: #f59e0b;
      --box2: #38bdf8;
      --panel: #f3f7ff;
      --ink: #0b172a;
      --muted: #42546c;
      --line: rgba(0, 0, 0, 0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Helvetica Neue", system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #d9ecff 0%, #b7dcff 55%, #9fcfff 100%);
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.02);
    }
    h1 { margin: 0 0 6px; font-size: 1.2rem; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .game-wrap {
      position: relative;
      flex: 1;
      overflow: hidden;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: linear-gradient(180deg, #d9ecff 0%, #b7dcff 55%, #9fcfff 100%);
    }
    .panel {
      position: absolute;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 16px;
      max-width: min(720px, 90vw);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      display: none;
      color: var(--ink);
    }
    .panel.active { display: block; }
    .panel .meta { display: none; }
    .panel .text { margin: 6px 0 0; line-height: 1.55; color: var(--ink); }
    .legend {
      position: absolute;
      top: 10px;
      right: 14px;
      background: rgba(0,0,0,0.35);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .skin-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: fit-content;
      margin-top: 6px;
    }
    .skin-option {
      width: 38px;
      height: 38px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      display: block;
      padding: 0;
      background: transparent;
      overflow: hidden;
      appearance: none;
      -webkit-appearance: none;
    }
    .skin-option .head,
    .skin-option .body,
    .skin-option .foot {
      display: block;
      width: 100%;
      height: 33%;
    }
    .skin-option .bow {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .skin-option.active {
      outline: 2px solid #0ea5e9;
      outline-offset: 2px;
    }

    .intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .intro-card {
      background: rgba(255,255,255,0.9);
      color: #0b172a;
      border-radius: 14px;
      padding: 18px;
      width: min(480px, 90vw);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 12px 32px rgba(0,0,0,0.35);
    }
    .intro-card h2 { margin: 0 0 8px; }
    .intro-card p { margin: 0 0 10px; line-height: 1.5; }
    .intro-card button {
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.6);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>√ûj√≥fsaga</h1>
  </header>
  <div class="game-wrap">
    <canvas id="game" width="1280" height="640"></canvas>
    <div class="legend" style="display:none;">Stj√≥rnun</div>
    <div class="panel" id="panel">
      <div class="meta" id="panelMeta"></div>
      <div class="text" id="panelText"></div>
    </div>
  </div>

  <div class="intro-overlay" id="introOverlay">
    <div class="intro-card" id="introCard">
      <h2>√ûj√≥fsaga</h2>
      <p>V√©lar hafa teki√∞ yfir heiminn, stoli√∞ √∂llum s√∂gunum og afbaka√∞ √æ√¶r. N√∫ er komi√∞ a√∞ √æ√©r a√∞ endurheimta √æ√¶r til a√∞ taka s√∂guna √æ√≠nar eigin hendur. Hver er √æ√≠n √ûj√≥fsaga?</p>
      <button id="toggleSkins" aria-label="Hver ert √æ√∫?">Hver ert √æ√∫?</button>
      <div id="skinGrid" class="skin-grid" aria-label="Veldu √∫tlit fyrir karakter" style="margin-top:6px; display:none;">
        <!-- fyllt √≠ me√∞ JS -->
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const panel = document.getElementById("panel");
    const panelMeta = document.getElementById("panelMeta");
    const panelText = document.getElementById("panelText");
    const skinGrid = document.getElementById("skinGrid");
    const toggleSkins = document.getElementById("toggleSkins");
    const introOverlay = document.getElementById("introOverlay");
    const introCard = document.getElementById("introCard");
    const gameWrap = document.querySelector(".game-wrap");

    const DATA_URL = encodeURI("ATU_Thompson Index_is/ ATU v√≠sitala.html");

    const world = {
      width: 4000,
      height: 640,
      gravity: 0.9,
      friction: 0.85,
    };

    const hazards = [
      { x: 1180 - 190, w: 140, h: 120, type: "spikes", yOffset: 60 },
      { x: 1800, w: 400, h: 120, type: "lava", yOffset: 60 },
      { x: 3000 - 100, w: 360, h: 120, type: "water", yOffset: 60 },
      { x: 1500 - 50, w: 300, h: 120, type: "void", yOffset: 60 },
    ]; // options: lava|water|void|spikes
    const stars = Array.from({ length: 50 }, () => ({
      x: Math.random() * 4000,
      y: Math.random() * 300,
      r: Math.random() * 1.4 + 0.6,
    }));
    const moon = { x: 3200, y: 80, r: 50 };
    const mountains = [
      { x: 0, y: 420, w: 800, h: 240 },
      { x: 700, y: 380, w: 900, h: 260 },
      { x: 1500, y: 400, w: 1100, h: 280 },
      { x: 2600, y: 370, w: 900, h: 270 },
      { x: 3400, y: 390, w: 800, h: 250 },
    ];
    const birds = Array.from({ length: 6 }, () => ({
      x: Math.random() * 4000,
      y: 120 + Math.random() * 120,
      speed: 0.6 + Math.random() * 0.6,
    }));

    const platforms = [
      { x: 0, y: 560, w: 1000, h: 80 },
      { x: 1100, y: 520, w: 500, h: 120 },
      { x: 1700, y: 500, w: 400, h: 140 },
      { x: 2200, y: 540, w: 700, h: 100 },
      { x: 3000, y: 480, w: 700, h: 160 },
      // l√≠till pallur til a√∞ n√° a√∞ √æri√∞ja kassa
      { x: 1220, y: 520, w: 120, h: 40 },
      // stigar a√∞ kassum √≠ lofti
      { x: 820, y: 440, w: 90, h: 20 },
      { x: 880, y: 380, w: 90, h: 20 },
      { x: 2720, y: 420, w: 90, h: 20 },
      { x: 2780, y: 360, w: 90, h: 20 },
    ];

    const boxes = [];
    const collected = [];

    const player = {
      x: 80,
      y: 400,
      w: 68,
      h: 92,
      vx: 0,
      vy: 0,
      speed: 0.9,
      jump: -16,
      onGround: false,
    };
    const skins = [
      { name: "klassisk", foot: "#3b82f6", body: "#f8fafc", head: "#d6a36f" },
      { name: "skogur", foot: "#22c55e", body: "#ecfccb", head: "#c28d6b" },
      { name: "eldur", foot: "#ef4444", body: "#fee2e2", head: "#c47a52" },
      { name: "snjor", foot: "#06b6d4", body: "#e0f2fe", head: "#b98b68" },
      { name: "gull", foot: "#f59e0b", body: "#fef9c3", head: "#d4a373" },
      { name: "naetur", foot: "#8b5cf6", body: "#ede9fe", head: "#b68a70" },
      { name: "rosa", foot: "#fb7185", body: "#ffe4e6", head: "#d99d7a", bow: "#e11d48" },
      { name: "kostmadur", foot: "#0f172a", body: "#e2e8f0", head: "#b18a68", bow: "#64748b" },
    ];
    let selectedSkin = skins[0];
    let motifsAll = [];
    let menuOverlay = null;
    let touchJumpTimer = null;
    let lastTap = 0;

    const keys = { left: false, right: false, jump: false };

    function bindControls() {
      const down = (code) => {
        if (code === "ArrowLeft" || code === "KeyA") keys.left = true;
        if (code === "ArrowRight" || code === "KeyD") keys.right = true;
        if (code === "Space" || code === "ArrowUp" || code === "KeyW") keys.jump = true;
      };
      const up = (code) => {
        if (code === "ArrowLeft" || code === "KeyA") keys.left = false;
        if (code === "ArrowRight" || code === "KeyD") keys.right = false;
        if (code === "Space" || code === "ArrowUp" || code === "KeyW") keys.jump = false;
      };
      window.addEventListener("keydown", (e) => { down(e.code); });
      window.addEventListener("keyup", (e) => { up(e.code); });

      // Touch controls: tap left/right half to move; double tap to jump
      function handleTouches(touches) {
        let left = false, right = false;
        const width = window.innerWidth || canvas.width;
        for (const t of touches) {
          const x = t.clientX || 0;
          if (x < width / 2) left = true; else right = true;
        }
        keys.left = left;
        keys.right = right;
      }

      function touchStart(e) {
        e.preventDefault();
        handleTouches(e.touches);
        const now = Date.now();
        if (now - lastTap < 300) {
          keys.jump = true;
          clearTimeout(touchJumpTimer);
          touchJumpTimer = setTimeout(() => { keys.jump = false; }, 150);
        }
        lastTap = now;
      }

      function touchMove(e) {
        e.preventDefault();
        handleTouches(e.touches);
      }

      function touchEnd(e) {
        e.preventDefault();
        handleTouches(e.touches);
        if (e.touches.length === 0) {
          keys.left = false;
          keys.right = false;
        }
      }

      gameWrap.addEventListener("touchstart", touchStart, { passive: false });
      gameWrap.addEventListener("touchmove", touchMove, { passive: false });
      gameWrap.addEventListener("touchend", touchEnd, { passive: false });
      gameWrap.addEventListener("touchcancel", touchEnd, { passive: false });
    }

    function sample(arr, n) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    function rectsCollide(a, b) {
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }

    function physics() {
      player.vx *= world.friction;
      if (keys.left) player.vx -= player.speed;
      if (keys.right) player.vx += player.speed;
      player.vy += world.gravity;

      player.x += player.vx;
      player.y += player.vy;
      player.onGround = false;

      // World bounds
      if (player.x < 0) { player.x = 0; player.vx = 0; }
      if (player.x + player.w > world.width) { player.x = world.width - player.w; player.vx = 0; }

      // Platform collisions (AABB + vertical resolution)
      platforms.forEach(p => {
        if (rectsCollide(player, p)) {
          const prevBottom = player.y - player.vy + player.h;
          const prevTop = player.y - player.vy;
          if (prevBottom <= p.y) {
            // landed on top
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          } else if (prevTop >= p.y + p.h) {
            // hit from below
            player.y = p.y + p.h;
            player.vy = 0;
          } else if (player.x < p.x) {
            player.x = p.x - player.w;
            player.vx = 0;
          } else {
            player.x = p.x + p.w;
            player.vx = 0;
          }
        }
      });

      if (keys.jump && player.onGround) {
        player.vy = player.jump;
        player.onGround = false;
      }

      // fall or hazard reset
      const hitHazard = hazards.some(h => rectsCollide(player, h));
      if (player.y > world.height + 100 || hitHazard) {
        resetPlayer();
      }
    }

    function render(cameraX) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(-cameraX, 0);

      // prepare hazard positions (align to ground)
      const baseY = world.height - 40;
      hazards.forEach(h => { h.y = baseY - h.h + (h.yOffset || 0); });

      // Parallax background: stars + moon
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      stars.forEach(s => {
        ctx.beginPath();
        ctx.arc(s.x - cameraX * 0.2, s.y + Math.sin(performance.now() * 0.003 + s.x) * 0.5, s.r, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.fillStyle = "#fef3c7";
      ctx.beginPath();
      ctx.arc(moon.x - cameraX * 0.15, moon.y, moon.r, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#d9ecff";
      ctx.beginPath();
      ctx.arc(moon.x - cameraX * 0.15 + 10, moon.y, moon.r * 0.9, 0, Math.PI * 2);
      ctx.fill();

      // Mountains (far)
      ctx.fillStyle = "#8fb7e5";
      mountains.forEach(m => {
        ctx.beginPath();
        ctx.moveTo(m.x - cameraX * 0.35, m.y + m.h);
        ctx.lineTo(m.x + m.w * 0.5 - cameraX * 0.35, m.y);
        ctx.lineTo(m.x + m.w - cameraX * 0.35, m.y + m.h);
        ctx.closePath();
        ctx.fill();
      });

      // Birds
      ctx.fillStyle = "#0f172a";
      birds.forEach(b => {
        b.x += b.speed;
        if (b.x - cameraX > world.width + 200) b.x = -200 + cameraX;
        ctx.beginPath();
        ctx.moveTo(b.x - cameraX, b.y);
        ctx.quadraticCurveTo(b.x - cameraX + 8, b.y - 4, b.x - cameraX + 16, b.y);
        ctx.quadraticCurveTo(b.x - cameraX + 8, b.y - 4, b.x - cameraX, b.y);
        ctx.fill();
      });

      // Hazards (behind platforms)
      const t = performance.now() * 0.003;
      hazards.forEach(hazard => {
        if (hazard.type === "water") {
          const grd = ctx.createLinearGradient(0, hazard.y, 0, hazard.y + hazard.h);
          grd.addColorStop(0, "rgba(110, 190, 255, 0.95)");
          grd.addColorStop(1, "rgba(40, 140, 240, 0.95)");
          ctx.fillStyle = grd;
          ctx.fillRect(hazard.x, hazard.y, hazard.w, hazard.h);
          ctx.strokeStyle = `rgba(255,255,255,${0.3 + 0.2 * Math.sin(t)})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let x = hazard.x; x <= hazard.x + hazard.w; x += 12) {
            const y = hazard.y - 4 + Math.sin((x * 0.08) + t) * 6;
            ctx.moveTo(x, y);
            ctx.lineTo(x + 8, y + Math.sin(t + x * 0.1));
          }
          ctx.stroke();
        } else if (hazard.type === "void") {
          ctx.fillStyle = "#0b1020";
          ctx.fillRect(hazard.x, hazard.y, hazard.w, hazard.h);
          ctx.fillStyle = `rgba(0,0,0,${0.4 + 0.2 * Math.sin(t * 1.5)})`;
          ctx.fillRect(hazard.x, hazard.y - 6, hazard.w, hazard.h + 12);
        } else if (hazard.type === "spikes") {
          ctx.fillStyle = "#0f172a";
          const spikeWidth = 16;
          for (let x = hazard.x; x < hazard.x + hazard.w; x += spikeWidth) {
            ctx.beginPath();
            ctx.moveTo(x, hazard.y + hazard.h);
            ctx.lineTo(x + spikeWidth / 2, hazard.y);
            ctx.lineTo(x + spikeWidth, hazard.y + hazard.h);
            ctx.closePath();
            ctx.fill();
          }
        } else {
          // lava
          const grd = ctx.createLinearGradient(0, hazard.y, 0, hazard.y + hazard.h);
          grd.addColorStop(0, "rgba(255,120,0,0.98)");
          grd.addColorStop(1, "rgba(180,15,0,0.98)");
          ctx.fillStyle = grd;
          ctx.fillRect(hazard.x, hazard.y, hazard.w, hazard.h);
          // glow
          ctx.save();
          ctx.globalCompositeOperation = "lighter";
          ctx.fillStyle = `rgba(255,150,50,${0.35 + 0.25 * Math.sin(t * 1.4)})`;
          ctx.fillRect(hazard.x - 6, hazard.y - 10, hazard.w + 12, hazard.h + 16);
          ctx.restore();
          // crest
          ctx.fillStyle = `rgba(255,220,120,${0.35 + 0.2 * Math.sin(t)})`;
          ctx.fillRect(hazard.x, hazard.y - 6, hazard.w, 10);
        }
      });
      // Ground/platforms (skip holes for hazards)
      ctx.fillStyle = "#6b4425";
      let cursor = 0;
      hazards
        .slice()
        .sort((a, b) => a.x - b.x)
        .forEach(h => {
          if (h.x > cursor) ctx.fillRect(cursor, world.height - 40, h.x - cursor, 40);
          cursor = h.x + h.w;
        });
      if (cursor < world.width) ctx.fillRect(cursor, world.height - 40, world.width - cursor, 40);
      ctx.fillStyle = "#8a5a30";
      platforms.forEach(p => {
        ctx.fillRect(p.x, p.y, p.w, p.h);
      });

    // Boxes as emoji
    ctx.font = "80px 'Apple Color Emoji','Segoe UI Emoji',sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const usedIcons = new Set();
    boxes.forEach((b) => {
        let icon = b.icon;
        if (usedIcons.has(icon)) {
          // pick another until unique for this run
          let tries = 0;
          while (tries < 20 && usedIcons.has(icon)) {
            icon = iconFor(b.motif);
            tries++;
          }
          b.icon = icon;
        }
        usedIcons.add(icon);
        ctx.fillText(icon || "‚¨ú", b.x + b.w / 2, b.y + b.h / 2);
      });

      // Player (8-bit blocks with vali√∞ √∫tlit)
      ctx.save();
      ctx.translate(player.x, player.y);
      const moving = Math.abs(player.vx) > 0.2;
      const step = moving ? Math.sin(performance.now() * 0.02) * 3 : 0;
      const jumpTilt = !player.onGround
        ? Math.max(0, Math.min(1, Math.abs(player.vy) / 12)) * 6
        : 0;
      // feet (flat; drop slightly apart when in air)
      ctx.fillStyle = selectedSkin.foot;
      const airFactor = !player.onGround ? Math.min(1, Math.abs(player.vy) / 12) : 0;
      const drop = airFactor * 10;
      const leftX = 0;
      const rightX = player.w / 2 + 4;
      ctx.fillRect(leftX, player.h - 12 + step + jumpTilt + drop, player.w / 2 - 4, 12);
      ctx.fillRect(rightX, player.h - 12 - step + jumpTilt + drop, player.w / 2 - 4, 12);
      // body
      const bodyX = 8;
      const bodyY = player.h - 48;
      const bodyW = player.w - 16;
      const bodyH = 36;
      ctx.fillStyle = selectedSkin.body;
      ctx.fillRect(bodyX, bodyY, bodyW, bodyH);
      // head
      const headX = 12;
      const headY = player.h - 76;
      const headW = player.w - 24;
      const headH = 24;
      ctx.fillStyle = selectedSkin.head;
      ctx.fillRect(headX, headY, headW, headH);
      // accessory
      if (selectedSkin.bow) {
        ctx.fillStyle = selectedSkin.bow;
        ctx.beginPath();
        ctx.moveTo(headX + headW - 6, headY + 6);
        ctx.lineTo(headX + headW + 6, headY + 2);
        ctx.lineTo(headX + headW + 4, headY + 14);
        ctx.closePath();
        ctx.fill();
        ctx.fillRect(headX + headW - 4, headY + 7, 6, 6);
      }
      // eyes
      ctx.fillStyle = "#1f2937";
      ctx.fillRect(player.w / 2 - 10, player.h - 70, 6, 6);
      ctx.fillRect(player.w / 2 + 4, player.h - 70, 6, 6);
      ctx.restore();

      // Exit checker mark
      const endX = world.width - 90;
      const endY = world.height - 200;
      const tile = 12;
      for (let y = 0; y < 200; y += tile) {
        for (let x = 0; x < 60; x += tile) {
          const isDark = ((x / tile) + (y / tile)) % 2 === 0;
          ctx.fillStyle = isDark ? "#0b172a" : "#f8fafc";
          ctx.fillRect(endX + x, endY + y, tile, tile);
        }
      }
      ctx.strokeStyle = "#111827";
      ctx.lineWidth = 2;
      ctx.strokeRect(endX, endY, 60, 200);

      ctx.restore();
    }

    function updatePanel() {
      let shown = false;
      boxes.forEach(b => {
      if (rectsCollide(player, b) || (Math.abs((player.x + player.w / 2) - (b.x + b.w / 2)) < 60 && Math.abs(player.y + player.h - b.y) < 80)) {
          panel.classList.add("active");
      panelText.innerHTML = `<div style="margin-bottom:8px;">${b.snippet}</div><div style="color:#5f728c;font-size:0.9rem;">${b.motif.cat || b.motif.title}</div>`;
          shown = true;
          if (!b.collected) {
            b.collected = true;
            collected.push({ motif: b.motif, snippet: b.snippet });
          }
        }
      });
      if (!shown) {
        panel.classList.remove("active");
      }
    }

    function loop() {
      physics();
      const cameraX = Math.max(0, Math.min(player.x - canvas.width / 2 + player.w / 2, world.width - canvas.width));
      render(cameraX);
      updatePanel();
      checkExit();
      requestAnimationFrame(loop);
    }

    function resetPlayer() {
      player.x = 80;
      player.y = 400;
      player.vx = 0;
      player.vy = 0;
      player.onGround = false;
    }

    function restartGame() {
      if (menuOverlay) {
        menuOverlay.remove();
        menuOverlay = null;
      }
      collected.length = 0;
      if (motifsAll.length) {
        placeBoxes(sample(motifsAll, 12));
      }
      panel.classList.remove("active");
      resetPlayer();
    }

    function buildSnippet(m) {
      // Use example if present; otherwise cat/title.
      if (m.example && m.example.trim()) {
        let text = m.example.trim();
        const words = text.split(/\s+/);
        if (words.length < 10) {
          return (m.cat && m.title)
            ? `${m.cat}: ${m.title}`
            : (m.title || m.cat || "Fr√°s√∂gn √≠ styttri mynd");
        }
        if (words.length > 100) {
          // reyna a√∞ klippa eftir n√∫meru√∞um hlutum (1)(2)(3) ...
          const parts = text.split(/\(\d+\)/).map(s => s.trim()).filter(Boolean);
          if (parts.length) {
            const picked = pick(parts.slice(0, 7).filter(Boolean)) || parts[0];
            text = picked.trim();
          } else {
            text = words.slice(0, 100).join(" ") + " ‚Ä¶";
          }
        }
        return text;
      }
      if (m.cat && m.title) return `${m.cat}: ${m.title}`;
      return m.title || m.cat || "Fr√°s√∂gn √≠ styttri mynd";
    }

    function colorFor(m) {
      const cat = (m.cat || "").toLowerCase();
      if (cat.includes("d√Ωras√∂gur")) return "#f59e0b";
      if (cat.includes("galdras√∂gur") || cat.includes("yfirn√°tt√∫ruleg")) return "#38bdf8";
      if (cat.includes("raunverulegar")) return "#22c55e";
      if (cat.includes("s√∂gur og brandarar") || cat.includes("brandarar")) return "#e879f9";
      if (cat.includes("form√∫lus√∂gur")) return "#f97316";
      return "#c084fc";
    }

    const defaultEmojis = ["ü¶ø","üîß","üë©üèª‚Äçüî¨","ü¶æ","‚öôÔ∏è","üëÅ‚Äçüó®","ü§ñ","üß†","üíª","‚ö´","üñ•Ô∏è","üíº"];
    const animalEmojis = ["ü¶ä","üê∫","üêª","üê∞","üê¶","üêó","üê∫","üê±"];
    const magicEmojis = ["üßô‚Äç‚ôÇÔ∏è","üßô‚Äç‚ôÄÔ∏è","‚ú®","üîÆ","ü™Ñ"];

    function iconFor(m) {
      const cat = (m.cat || "").toLowerCase();
      if (cat.includes("d√Ωras√∂gur")) return pick(animalEmojis);
      if (cat.includes("galdras√∂gur") || cat.includes("yfirn√°tt√∫ruleg")) return pick(magicEmojis);
      return pick(defaultEmojis);
    }

    async function loadMotifs() {
      const res = await fetch(DATA_URL);
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const rows = Array.from(doc.querySelectorAll("table.waffle tr")).slice(2);
      motifsAll = [];
      rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll("td"));
        if (!cells.length) return;
        const id = cells[0]?.textContent.trim();
        const sub = cells[1]?.textContent.trim();
        const title = cells[2]?.textContent.trim();
        const cat = cells[3]?.textContent.trim();
        const subcat = cells[4]?.textContent.trim();
        const example = cells[5]?.textContent.trim();
        if (!id || !title) return;
        motifsAll.push({
          id: sub && sub !== "-" ? `${id}${sub}` : id,
          title,
          cat: subcat ? `${cat} ‚Äî ${subcat}` : cat || "",
          example,
        });
      });
      placeBoxes(sample(motifsAll, 12));
    }

    function placeBoxes(motifs) {
      boxes.length = 0;
      const spots = [
        { x: 220, y: 480 }, { x: 620, y: 480 }, { x: 1250, y: 440 },
        { x: 1500, y: 440 }, { x: 1850, y: 420 }, { x: 2350, y: 480 },
        { x: 2650, y: 480 }, { x: 3050, y: 420 }, { x: 3350, y: 420 },
        { x: 3600, y: 420 }, { x: 900, y: 300 }, { x: 2800, y: 320 },
      ];
      motifs.forEach((m, i) => {
        const spot = spots[i % spots.length];
        boxes.push({
          x: spot.x,
          y: spot.y,
          w: 80,
          h: 80,
          motif: m,
          snippet: buildSnippet(m),
          color: colorFor(m),
          collected: false,
          icon: iconFor(m),
        });
      });
    }

    // Skin selection rendered as grid of mini characters
    function renderSkinSelect() {
      const fragments = skins.map((s, idx) => {
        return `
          <button class="skin-option" data-idx="${idx}" aria-label="√ötlit ${idx + 1}">
            <div class="head" style="background:${s.head};"></div>
            <div class="body" style="background:${s.body};"></div>
            <div class="foot" style="background:${s.foot};"></div>
            ${s.bow ? `<div class="bow" style="background:${s.bow};"></div>` : ""}
          </button>
        `;
      }).join("");
      skinGrid.innerHTML = fragments;
      skinGrid.querySelectorAll(".skin-option").forEach(btn => {
        btn.addEventListener("click", () => {
          skinGrid.querySelectorAll(".skin-option").forEach(el => el.classList.remove("active"));
          btn.classList.add("active");
          const idx = Number(btn.dataset.idx) || 0;
          selectedSkin = skins[Math.max(0, Math.min(skins.length - 1, idx))];
        });
      });
      const first = skinGrid.querySelector(".skin-option");
      if (first) first.classList.add("active");

      function closeIntro() {
        introOverlay.style.display = "none";
        skinGrid.style.display = "none";
        toggleSkins.textContent = "Hver ert √æ√∫?";
      }

      toggleSkins.addEventListener("click", (e) => {
        e.stopPropagation();
        const visible = skinGrid.style.display !== "none";
        if (visible) {
          closeIntro();
        } else {
          skinGrid.style.display = "grid";
          toggleSkins.textContent = "Lj√∫ka vali";
        }
      });
      introOverlay.addEventListener("click", (e) => {
        if (e.target === introOverlay) {
          closeIntro();
        }
      });
      introCard.addEventListener("click", (e) => e.stopPropagation());
    }

    // Exit/menu display
    function checkExit() {
      const allCollected = collected.length >= boxes.length && boxes.length > 0;
      const atExit = player.x + player.w > world.width - 90;
      if (allCollected && atExit) {
        showCollectedMenu();
      }
    }

    function showCollectedMenu() {
      if (menuOverlay) return;
      const list = collected.map(item => `<li><strong>${item.motif.id}</strong> ‚Äî ${item.motif.title}<br><span style="color:#5f728c;font-size:0.9rem;">${item.motif.cat || ""}</span><br>${item.snippet}</li>`).join("");
      const html = `
        <div id="menuOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:50;">
          <div style="background:#0c1426;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px;max-width:800px;max-height:80vh;overflow:auto;color:#e2e8f0;font-family:Inter, sans-serif;line-height:1.5;position:relative;">
            <h2 style="margin:0 0 8px;">Sagan √æ√≠n</h2>
            <p style="margin:0 0 10px;color:#94a3b8;">Allir s√∂gub√∫tarnir sem √æ√∫ fannst:</p>
            <ul style="list-style:disc;padding-left:18px;">${list.replace(/(<br>)([^<]+)/g, (_, br, rest) => `${br}<span style="color:#94a3b8;font-size:0.9rem;">${rest}</span>`)}</ul>
            <p style="margin:12px 0 0;color:#94a3b8;font-size:0.9rem;">Allar fr√°sagnir fengnar √∫r Aarne‚ÄìThompson‚ÄìUther Index √æ√Ωddar me√∞ v√©l√æ√Ω√∞ingu.</p>
            <button id="closeMenu" style="margin-top:12px;padding:8px 12px;border:none;border-radius:8px;background:#22c55e;color:#0b0f1a;font-weight:700;cursor:pointer;">Hefja n√Ωja √æj√≥fs√∂gu</button>
          </div>
        </div>
      `;
      const wrap = document.createElement("div");
      wrap.innerHTML = html;
      document.body.appendChild(wrap);
      menuOverlay = wrap;
      const close = () => restartGame();
      wrap.querySelector("#closeMenu").addEventListener("click", close, { once: true });
      wrap.addEventListener("click", (e) => { if (e.target.id === "menuOverlay") close(); });
      window.addEventListener("keydown", function onKey(e) {
        if (e.code === "Space") { e.preventDefault(); close(); window.removeEventListener("keydown", onKey); }
      });
    }

    bindControls();
    loadMotifs().catch(err => console.error(err));
    renderSkinSelect();
    loop();
  </script>
</body>
</html>
