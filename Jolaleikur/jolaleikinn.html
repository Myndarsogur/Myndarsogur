<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Myndars√∂gur √≠ sk√≥inn</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.16), transparent 30%), radial-gradient(circle at 80% 10%, rgba(255,255,255,0.18), transparent 28%), linear-gradient(180deg, #0a0f24 0%, #0f1d46 55%, #0c254c 100%);
      --ground: #ffffff;
      --snow: #f8fafc;
      --panel: rgba(255,255,255,0.92);
      --ink: #0b172a;
      --muted: #42546c;
      --line: rgba(255, 255, 255, 0.14);
      --accent: #f97316;
      --accent2: #22d3ee;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Helvetica Neue", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--ink);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, 0.35);
      color: #e2e8f0;
    }
    h1 { margin: 0 0 6px; font-size: 1.2rem; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .game-wrap {
      position: relative;
      flex: 1;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      background: var(--bg);
      touch-action: none;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .panel {
      position: absolute;
      left: 50%;
      top: 48px;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      padding: 10px 12px;
      max-width: min(420px, 92vw);
      box-shadow: 0 12px 28px rgba(0,0,0,0.2);
      display: none;
      color: var(--ink);
      pointer-events: none;
    }
    .panel.active { display: block; }
    .panel .meta { display: none; }
    .panel .text { margin: 6px 0 0; line-height: 1.55; color: var(--ink); }

    @media (max-width: 768px) {
      .panel {
        font-size: 0.9rem;
        padding: 10px 12px;
        max-width: 86vw;
        top: 8px;
      }
      .panel .text { line-height: 1.4; }
    }
    .legend {
      position: absolute;
      top: 10px;
      right: 14px;
      background: rgba(0,0,0,0.35);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .santa-bubble {
      position: fixed;
      left: 50%;
      bottom: auto;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.96);
      color: #0b172a;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 8px;
      padding: 6px 8px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.16);
      font-weight: 600;
      font-size: 0.85rem;
      display: none;
      z-index: 80;
      max-width: min(180px, 92vw);
      text-align: center;
    }

    .skin-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      width: fit-content;
      margin-top: 6px;
    }
    .skin-option {
      width: 38px;
      height: 38px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      display: block;
      padding: 0;
      background: transparent;
      overflow: hidden;
      appearance: none;
      -webkit-appearance: none;
    }
    .skin-option .head,
    .skin-option .body,
    .skin-option .foot {
      display: block;
      width: 100%;
      height: 33%;
    }
    .skin-option .hat {
      position: absolute;
      top: 2px;
      left: 6px;
      right: 6px;
      height: 8px;
      border-radius: 4px 4px 2px 2px;
    }
    .skin-option .hat-trim {
      position: absolute;
      top: 0;
      left: 4px;
      right: 4px;
      height: 4px;
      border-radius: 6px;
    }
    .skin-option .beard {
      position: absolute;
      left: 10px;
      right: 10px;
      bottom: 6px;
      height: 8px;
      border-radius: 0 0 6px 6px;
    }
    .skin-option .braids {
      position: absolute;
      left: 6px;
      right: 6px;
      bottom: 4px;
      height: 6px;
      border-radius: 6px;
      opacity: 0.9;
    }
    .skin-option .bow {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    .skin-option.active {
      outline: 2px solid #0ea5e9;
      outline-offset: 2px;
    }

    .intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    .intro-card {
      background: rgba(255,255,255,0.9);
      color: #0b172a;
      border-radius: 14px;
      padding: 18px;
      width: min(480px, 90vw);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 12px 32px rgba(0,0,0,0.35);
    }
    .intro-card h2 { margin: 0 0 8px; }
    .intro-card p { margin: 0 0 10px; line-height: 1.5; }
    .intro-card button {
      border: 1px solid rgba(0,0,0,0.15);
      background: rgba(255,255,255,0.6);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <h1>Myndars√∂gur √≠ sk√≥inn</h1>
  </header>
  <div class="game-wrap">
    <canvas id="game" width="1280" height="640"></canvas>
    <div class="legend" style="display:none;">Stj√≥rnun</div>
    <div class="panel" id="panel">
      <div class="meta" id="panelMeta"></div>
      <div class="text" id="panelText"></div>
    </div>
  </div>

  <div class="intro-overlay" id="introOverlay">
    <div class="intro-card" id="introCard">
      <h2>Myndars√∂gur √≠ sk√≥inn</h2>
      <p>Safna√∞u j√≥laemoji √≠ sekkinn og hoppa√∞u upp a√∞ st√≥ru h√°h√Ωsi undir lokin. Settu einn hlut √≠ hvern glugga og skreyttu h√∫si√∞ me√∞ gle√∞i.</p>
      <button id="toggleSkins" aria-label="Hver ert √æ√∫?">Veldu j√≥lasvein</button>
      <div id="skinGrid" class="skin-grid" aria-label="Veldu √∫tlit fyrir karakter" style="margin-top:6px; display:none;">
        <!-- fyllt √≠ me√∞ JS -->
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const panel = document.getElementById("panel");
    const panelMeta = document.getElementById("panelMeta");
    const panelText = document.getElementById("panelText");
    const skinGrid = document.getElementById("skinGrid");
    const toggleSkins = document.getElementById("toggleSkins");
    const introOverlay = document.getElementById("introOverlay");
    const introCard = document.getElementById("introCard");
    const gameWrap = document.querySelector(".game-wrap");
    const santaBubble = (() => {
      const el = document.createElement("div");
      el.className = "santa-bubble";
      const span = document.createElement("div");
      span.className = "santa-bubble-text";
      el.appendChild(span);
      document.body.appendChild(el);
      return el;
    })();

    const lootPool = [
      { name: "Pakki", emoji: "üéÅ", note: "Pakki, pakki, pakka √æessum j√≥lum saman!", avif: "assets/jolaleikinn/gift.avif", color: "#f97316" },
      { name: "Bjalla", emoji: "üîî", note: "Set √æessa kannski √° j√≥lak√∂ttinn til a√∞ bjarga b√∂rnunum.", avif: "assets/jolaleikinn/bell.avif", color: "#fbbf24" },
      { name: "Snj√≥korn", emoji: "‚ùÑÔ∏è", note: "√ûetta er sni√∞ug j√≥lagj√∂f gott a√∞ f√° hana beint √≠ sk√≥inn.", avif: "assets/jolaleikinn/snowflake.avif", color: "#a5b4fc" },
      { name: "J√≥latr√©", emoji: "üéÑ", note: "V√° hva√∞ √æessi ver√∞ur hissa a√∞ f√° j√≥latr√© √≠ sk√≥inn.", avif: "assets/jolaleikinn/tree.avif", color: "#22c55e" },
      { name: "Stjarna", emoji: "‚≠êÔ∏è", note: "Stj√∂rnur eru mi√∞jurnar √≠ s√≥lkerfum, √æetta er alveg vegleg gj√∂f.", avif: "assets/jolaleikinn/star.avif", color: "#facc15" },
      { name: "Piparkaka", emoji: "üç™", note: "Orku til a√∞ arka, gott fyrir sveina sem harka", avif: "assets/jolaleikinn/cookie.avif", color: "#f59e0b" },
      { name: "Sykurstafur", emoji: "üç¨", note: "Mmm tannl√¶knar m√¶la eflaust me√∞ √æessum", avif: "assets/jolaleikinn/candy.avif", color: "#e879f9" },
      { name: "Vettlingur", emoji: "üß§", note: "Kaldar hendur, aldrei ekki me√∞ √æessum, √æessir eru rafmagns.", avif: "assets/jolaleikinn/mitten.avif", color: "#38bdf8" },
      { name: "J√≥lasokkur", emoji: "üß¶", note: "Sokkur √≠ sk√≥inn, √æa√∞ er hilar√≠us.", avif: "assets/jolaleikinn/stocking.avif", color: "#fda4af" },
      { name: "Sle√∞i", emoji: "üõ∑", note: "Sle√∞i sle√∞i sle√∞i... sle√∞i l√≠f mitt er!", avif: "assets/jolaleikinn/sled.avif", color: "#38bdf8" },
      { name: "Slaufa", emoji: "üéÄ", note: "√ûa√∞ eru allir s√¶tari me√∞ slaufu √° s√©r, sta√∞reynd.", avif: "assets/jolaleikinn/wreath.avif", color: "#34d399" },
      { name: "Kerti", emoji: "üïØÔ∏è", note: "Br√≥√∞ir minn m√° ekki finna √æetta.", avif: "assets/jolaleikinn/candle.avif", color: "#fbbf24" },
    ];
    const coverImage = new Image();
    let coverReady = false;
    let coverSrc = "";
    let coverRatio = 1;

    function loadCoverSource() {
      const sources = [
        "forsida_pixel_96w_base.png",
        "forsida_pixel_128w_8x.png",
        "assets/jolaleikinn/forsida_pixel_96w_base.png",
        "assets/jolaleikinn/forsida_pixel_128w_8x.png",
        "assets/jolaleikinn/forsida.png",
        "assets/jolaleikinn/forsida.avif"
      ];
      let idx = 0;
      const tryLoad = () => {
        if (idx >= sources.length) return;
        coverSrc = sources[idx];
        coverImage.onload = () => {
          coverReady = true;
          if (coverImage.width && coverImage.height) {
            coverRatio = coverImage.width / coverImage.height;
          }
        };
        coverImage.onerror = () => { idx += 1; tryLoad(); };
        coverImage.src = coverSrc;
      };
      tryLoad();
    }
    loadCoverSource();

    const building = { x: 3200, y: 170, w: 520, h: 430 };
    const windows = [];
    const windowSize = { w: 90, h: 70 };

    const world = {
      width: 4200,
      height: 640,
      gravity: 0.9,
      friction: 0.85,
    };

    const hazards = [
      { x: 980, w: 160, h: 120, type: "ice", yOffset: 80 },
      { x: 1820, w: 380, h: 130, type: "river", yOffset: 70 },
      { x: 2600, w: 440, h: 120, type: "ice", yOffset: 60 },
    ];
    const snowflakes = Array.from({ length: 120 }, () => ({
      x: Math.random() * 4000,
      y: Math.random() * 300,
      r: Math.random() * 1.4 + 0.6,
      drift: Math.random() * 0.4 + 0.2,
    }));
    const moon = { x: 3200, y: 80, r: 50 };
    const mountains = [
      { x: 0, y: 420, w: 800, h: 240 },
      { x: 700, y: 380, w: 900, h: 260 },
      { x: 1500, y: 400, w: 1100, h: 280 },
      { x: 2600, y: 370, w: 900, h: 270 },
      { x: 3400, y: 390, w: 800, h: 250 },
    ];

    const platforms = [
      { x: 0, y: 560, w: 1000, h: 180 },
      { x: 1100, y: 520, w: 500, h: 220 },
      { x: 1700, y: 500, w: 400, h: 240 },
      { x: 2200, y: 540, w: 700, h: 200 },
      { x: 3000, y: 480, w: 760, h: 260 },
      // l√≠till pallur til a√∞ n√° a√∞ √æri√∞ja kassa
      { x: 1220, y: 520, w: 120, h: 40 },
      // stigar a√∞ kassum √≠ lofti
      { x: 820, y: 440, w: 90, h: 20 },
      { x: 880, y: 380, w: 90, h: 20 },
      { x: 2720, y: 420, w: 90, h: 20 },
      { x: 2780, y: 360, w: 90, h: 20 },
      // pallar a√∞ h√°h√Ωsi
      { x: 3400, y: 420, w: 160, h: 40 },
      { x: 3580, y: 420, w: 180, h: 40 },
      { x: 3520, y: 340, w: 160, h: 40 },
      { x: 3640, y: 260, w: 160, h: 40 },
      { x: 3760, y: 200, w: 160, h: 40 },
      { x: 3820, y: 440, w: 200, h: 50 }, // aftan vi√∞ h√∫si√∞ til a√∞ n√° ne√∞ri glugga
    ];

    const boxes = [];
    const collected = [];
    const bag = [];
    let celebrationShown = false;
    let popupUntil = 0;
    let santaTimer = null;
    let santaTypeTimer = null;
    let lastCameraX = 0;
    let panelTypeTimer = null;
    let panelCurrentKey = "";
    let coverRevealActive = false;
    let coverRevealStart = 0;
    let coverRevealDone = false;

    const player = {
      x: 80,
      y: 400,
      w: 68,
      h: 92,
      vx: 0,
      vy: 0,
      speed: 0.9,
      jump: -16,
      onGround: false,
    };
    const skins = [
      { name: "Klass√≠skur rau√∞ur", suit: "#d62828", trim: "#f8fafc", beard: "#f8fafc", hat: "#d62828", hatTrim: "#f8fafc", belt: "#111827", boots: "#0b172a", head: "#f2c7a3" },
      { name: "Sk√≥gargr√¶nn", suit: "#0f9d58", trim: "#f8fafc", beard: "#f0d4b4", hat: "#0f9d58", hatTrim: "#ecfeff", belt: "#0f172a", boots: "#0f172a", head: "#edc7a1" },
      { name: "N√¶turbl√°r", suit: "#0ea5e9", trim: "#e0f2fe", beard: "#e2e8f0", hat: "#0284c7", hatTrim: "#bae6fd", belt: "#0b172a", boots: "#0b172a", head: "#f3c7a0" },
      { name: "Kastan√≠ubr√∫nt skegg", suit: "#7f1d1d", trim: "#fef3c7", beard: "#c08457", hat: "#991b1b", hatTrim: "#fde68a", belt: "#111827", boots: "#1f2937", head: "#f3c7a0" },
      { name: "Fj√≥lubl√°r me√∞ svartan skegg", suit: "#7c3aed", trim: "#ede9fe", beard: "#111827", hat: "#6d28d9", hatTrim: "#f5f3ff", belt: "#111827", boots: "#0f172a", head: "#efcfb5" },
      { name: "Snj√≥hv√≠tt skegg", suit: "#2563eb", trim: "#e5edff", beard: "#f8fafc", hat: "#1d4ed8", hatTrim: "#dbeafe", belt: "#0b172a", boots: "#0b172a", head: "#f1c8a2" },
      { name: "Stelpuj√≥lasveinn bleikur", suit: "#ec4899", trim: "#ffe4e6", beard: null, bow: "#f43f5e", hat: "#e11d48", hatTrim: "#ffe4e6", belt: "#0f172a", boots: "#111827", head: "#f6c9a8", braids: "#f59eb4" },
      { name: "Stelpuj√≥lasveinn fj√≥lubl√°r", suit: "#a855f7", trim: "#f3e8ff", beard: null, bow: "#c084fc", hat: "#9333ea", hatTrim: "#f3e8ff", belt: "#111827", boots: "#111827", head: "#f5cba6", braids: "#d8b4fe" },
    ];
    let selectedSkin = skins[0];
    let lootList = [];
    let menuOverlay = null;
    let touchJumpTimer = null;
    let lastTap = 0;

    const keys = { left: false, right: false, jump: false };

    function bindControls() {
      const down = (code) => {
        if (code === "ArrowLeft" || code === "KeyA") keys.left = true;
        if (code === "ArrowRight" || code === "KeyD") keys.right = true;
        if (code === "Space" || code === "ArrowUp" || code === "KeyW") keys.jump = true;
      };
      const up = (code) => {
        if (code === "ArrowLeft" || code === "KeyA") keys.left = false;
        if (code === "ArrowRight" || code === "KeyD") keys.right = false;
        if (code === "Space" || code === "ArrowUp" || code === "KeyW") keys.jump = false;
      };
      window.addEventListener("keydown", (e) => { down(e.code); });
      window.addEventListener("keyup", (e) => { up(e.code); });

      // Touch controls: tap left/right half to move; double tap to jump
      function handleTouches(touches) {
        let left = false, right = false;
        const width = window.innerWidth || canvas.width;
        for (const t of touches) {
          const x = t.clientX || 0;
          if (x < width / 2) left = true; else right = true;
        }
        keys.left = left;
        keys.right = right;
      }

      function touchStart(e) {
        e.preventDefault();
        handleTouches(e.touches);
        const now = Date.now();
        if (now - lastTap < 300) {
          keys.jump = true;
          clearTimeout(touchJumpTimer);
          touchJumpTimer = setTimeout(() => { keys.jump = false; }, 150);
        }
        lastTap = now;
      }

      function touchMove(e) {
        e.preventDefault();
        handleTouches(e.touches);
      }

      function touchEnd(e) {
        e.preventDefault();
        handleTouches(e.touches);
        if (e.touches.length === 0) {
          keys.left = false;
          keys.right = false;
        }
      }

      gameWrap.addEventListener("touchstart", touchStart, { passive: false });
      gameWrap.addEventListener("touchmove", touchMove, { passive: false });
      gameWrap.addEventListener("touchend", touchEnd, { passive: false });
      gameWrap.addEventListener("touchcancel", touchEnd, { passive: false });
    }

    function sample(arr, n) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    function rectsCollide(a, b) {
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }

    function setupWindows() {
      windows.length = 0;
      const cols = 4;
      const rows = 3;
      const startX = building.x + 60;
      const startY = building.y + 80;
      const gapX = 110;
      const gapY = 90;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          windows.push({
            x: startX + c * gapX,
            y: startY + r * gapY,
            item: null,
            coverShown: false,
          });
        }
      }
    }

    function physics() {
      player.vx *= world.friction;
      if (keys.left) player.vx -= player.speed;
      if (keys.right) player.vx += player.speed;
      player.vy += world.gravity;

      player.x += player.vx;
      player.y += player.vy;
      player.onGround = false;

      // World bounds
      if (player.x < 0) { player.x = 0; player.vx = 0; }
      if (player.x + player.w > world.width) { player.x = world.width - player.w; player.vx = 0; }

      // Platform collisions (AABB + vertical resolution)
      platforms.forEach(p => {
        if (rectsCollide(player, p)) {
          const prevBottom = player.y - player.vy + player.h;
          const prevTop = player.y - player.vy;
          if (prevBottom <= p.y) {
            // landed on top
            player.y = p.y - player.h;
            player.vy = 0;
            player.onGround = true;
          } else if (prevTop >= p.y + p.h) {
            // hit from below
            player.y = p.y + p.h;
            player.vy = 0;
          } else if (player.x < p.x) {
            player.x = p.x - player.w;
            player.vx = 0;
          } else {
            player.x = p.x + p.w;
            player.vx = 0;
          }
        }
      });

      if (keys.jump && player.onGround) {
        player.vy = player.jump;
        player.onGround = false;
      }

      // fall or hazard reset
      const hitHazard = hazards.some(h => rectsCollide(player, h));
      if (player.y > world.height + 100 || hitHazard) {
        resetPlayer();
      }
    }

    function render(cameraX) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(-cameraX, 0);

      // prepare hazard positions (align to ground)
      const baseY = world.height - 40;
      hazards.forEach(h => { h.y = baseY - h.h + (h.yOffset || 0); });

      // Parallax background: snj√≥korn + tungl + nor√∞urlj√≥s
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      snowflakes.forEach(s => {
        s.y += s.drift;
        s.x += Math.sin(performance.now() * 0.001 + s.y * 0.01) * 0.5;
        if (s.y > canvas.height + 20) s.y = -20;
        ctx.beginPath();
        ctx.arc(s.x - cameraX * 0.2, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      });
      // softly waving aurora
      const t = performance.now() * 0.0005;
      const auroraHeight = 140;
      const auroraTop = 90;
      const grdAurora = ctx.createLinearGradient(0, auroraTop, 0, auroraTop + auroraHeight);
      grdAurora.addColorStop(0, "rgba(56,189,248,0.12)");
      grdAurora.addColorStop(1, "rgba(236,72,153,0.08)");
      ctx.fillStyle = grdAurora;
      ctx.beginPath();
      ctx.moveTo(0, auroraTop);
      for (let x = 0; x <= canvas.width + 200; x += 40) {
        const wave = Math.sin(t * 2 + x * 0.01) * 16 + Math.cos(t + x * 0.02) * 10;
        ctx.lineTo(x - 100 + Math.sin(t + x * 0.03) * 6 + cameraX * -0.08, auroraTop + wave);
      }
      ctx.lineTo(canvas.width + 200, auroraTop + auroraHeight);
      ctx.lineTo(-200, auroraTop + auroraHeight);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = "#fef3c7";
      ctx.beginPath();
      ctx.arc(moon.x - cameraX * 0.15, moon.y, moon.r, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#d9ecff";
      ctx.beginPath();
      ctx.arc(moon.x - cameraX * 0.15 + 10, moon.y, moon.r * 0.9, 0, Math.PI * 2);
      ctx.fill();

      // Mountains (far)
      ctx.fillStyle = "#8fb7e5";
      mountains.forEach(m => {
        ctx.beginPath();
        ctx.moveTo(m.x - cameraX * 0.35, m.y + m.h);
        ctx.lineTo(m.x + m.w * 0.5 - cameraX * 0.35, m.y);
        ctx.lineTo(m.x + m.w - cameraX * 0.35, m.y + m.h);
        ctx.closePath();
        ctx.fill();
      });

      // Hazards (behind platforms)
      const tHaz = performance.now() * 0.003;
      hazards.forEach((hazard, idx) => {
        const drawY = hazard.y;
        const drawH = hazard.h + 140; // stretch deeper to hide any white line
        if (hazard.type === "river") {
          const grd = ctx.createLinearGradient(0, drawY, 0, drawY + drawH);
          grd.addColorStop(0, "rgba(125, 211, 252, 0.9)");
          grd.addColorStop(1, "rgba(56, 189, 248, 0.95)");
          ctx.fillStyle = grd;
          ctx.fillRect(hazard.x, drawY, hazard.w, drawH);
          ctx.strokeStyle = `rgba(255,255,255,${0.3 + 0.2 * Math.sin(tHaz)})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          for (let x = hazard.x; x <= hazard.x + hazard.w; x += 12) {
            const y = hazard.y - 4 + Math.sin((x * 0.08) + tHaz) * 6;
            ctx.moveTo(x, y);
            ctx.lineTo(x + 8, y + Math.sin(tHaz + x * 0.1));
          }
          ctx.stroke();
        } else if (hazard.type === "void") {
          ctx.fillStyle = "#0b1020";
          ctx.fillRect(hazard.x, drawY, hazard.w, drawH);
          ctx.fillStyle = `rgba(0,0,0,${0.4 + 0.2 * Math.sin(tHaz * 1.5)})`;
          ctx.fillRect(hazard.x, hazard.y - 6, hazard.w, hazard.h + 12);
        } else if (hazard.type === "ice") {
          const grd = ctx.createLinearGradient(0, drawY, 0, drawY + drawH);
          grd.addColorStop(0, "rgba(226, 232, 240, 0.9)");
          grd.addColorStop(1, "rgba(148, 163, 184, 0.9)");
          ctx.fillStyle = grd;
          ctx.fillRect(hazard.x, drawY, hazard.w, drawH);
          ctx.strokeStyle = `rgba(255,255,255,${0.4 + 0.2 * Math.sin(tHaz * 1.1)})`;
          ctx.lineWidth = 3;
          ctx.beginPath();
          for (let x = hazard.x; x <= hazard.x + hazard.w; x += 16) {
            const y = hazard.y + 6 + Math.sin((x * 0.05) + tHaz) * 4;
            ctx.moveTo(x, y);
            ctx.lineTo(x + 10, y + Math.sin(tHaz + x * 0.1));
          }
          ctx.stroke();
        }
      });
      // Ground/platforms (skip holes for hazards)
      ctx.fillStyle = "#ffffff";
      let cursor = 0;
      hazards
        .slice()
        .sort((a, b) => a.x - b.x)
        .forEach(h => {
          if (h.x > cursor) ctx.fillRect(cursor, world.height - 40, h.x - cursor, 40);
          cursor = h.x + h.w;
        });
      if (cursor < world.width) ctx.fillRect(cursor, world.height - 40, world.width - cursor, 40);
      ctx.fillStyle = "#ffffff";
      platforms.forEach(p => {
        ctx.fillRect(p.x, p.y, p.w, p.h);
        ctx.fillStyle = "rgba(0,0,0,0.08)";
        ctx.fillRect(p.x, p.y, p.w, 8);
        ctx.fillStyle = "#ffffff";
      });
      ctx.fillStyle = "#ffffff";
      const snowY = world.height - 50;
      const snowH = 14;
      let sx = 0;
      hazards
        .slice()
        .sort((a, b) => a.x - b.x)
        .forEach(h => {
          if (h.x > sx) ctx.fillRect(sx, snowY, h.x - sx, snowH);
          sx = h.x + h.w;
        });
      if (sx < world.width) ctx.fillRect(sx, snowY, world.width - sx, snowH);

      // Building with windows near end
      ctx.fillStyle = "#0b162f";
      ctx.fillRect(building.x - 10, building.y + building.h, building.w + 20, 16);
      const facadeGrad = ctx.createLinearGradient(0, building.y, 0, building.y + building.h);
      facadeGrad.addColorStop(0, "#0f1f3f");
      facadeGrad.addColorStop(1, "#0c1024");
      ctx.fillStyle = facadeGrad;
      ctx.fillRect(building.x, building.y, building.w, building.h);
      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(building.x, building.y, building.w, 8);
      const allFilled = allWindowsFilled();
      windows.forEach((w, idx) => {
        ctx.fillStyle = allFilled ? "#fef3c7" : "rgba(148,163,184,0.2)";
        ctx.fillRect(w.x, w.y, windowSize.w, windowSize.h);
        ctx.strokeStyle = "rgba(255,255,255,0.35)";
        ctx.lineWidth = 3;
        ctx.strokeRect(w.x, w.y, windowSize.w, windowSize.h);
        ctx.fillStyle = "rgba(255,255,255,0.12)";
        ctx.fillRect(w.x + 6, w.y + 6, windowSize.w - 12, windowSize.h - 12);
        if (w.item) {
          if (w.coverShown && coverReady) {
            const prevSmooth = ctx.imageSmoothingEnabled;
            ctx.imageSmoothingEnabled = false;
            const elapsed = performance.now() - coverRevealStart;
            const t = Math.min(1, Math.max(0, (elapsed - idx * 20) / 200));
            const scale = coverRevealActive ? 0.9 + 0.1 * t : 1;
            ctx.save();
            ctx.translate(w.x + windowSize.w / 2, w.y + windowSize.h / 2);
            ctx.scale(scale, scale);
            const targetH = windowSize.h - 8;
            const targetW = Math.min(windowSize.w - 12, targetH * coverRatio);
            ctx.drawImage(
              coverImage,
              -targetW / 2,
              -targetH / 2 + 2,
              targetW,
              targetH
            );
            ctx.restore();
            ctx.imageSmoothingEnabled = prevSmooth;
          } else {
            ctx.font = "46px 'Apple Color Emoji','Segoe UI Emoji',sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(w.item.emoji, w.x + windowSize.w / 2, w.y + windowSize.h / 2);
          }
        }
      });
      // roof snow cap
      ctx.fillStyle = "#e2e8f0";
      ctx.fillRect(building.x - 6, building.y - 12, building.w + 12, 14);

      // Boxes as emoji
      ctx.font = "80px 'Apple Color Emoji','Segoe UI Emoji',sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      boxes.forEach((b) => {
        if (b.collected) return;
        const icon = b.icon || b.item?.emoji || "üéÅ";
        ctx.fillText(icon, b.x + b.w / 2, b.y + b.h / 2);
      });

      // Player (8-bit blocks with vali√∞ √∫tlit)
      ctx.save();
      ctx.translate(player.x, player.y);
      const s = selectedSkin;
      const moving = Math.abs(player.vx) > 0.2;
      const step = moving ? Math.sin(performance.now() * 0.02) * 3 : 0;
      const jumpTilt = !player.onGround
        ? Math.max(0, Math.min(1, Math.abs(player.vy) / 12)) * 6
        : 0;
      // feet (flat; drop slightly apart when in air)
      const bootColor = s.boots || "#111827";
      ctx.fillStyle = bootColor;
      const airFactor = !player.onGround ? Math.min(1, Math.abs(player.vy) / 12) : 0;
      const drop = airFactor * 10;
      const leftX = 0;
      const rightX = player.w / 2 + 4;
      ctx.fillRect(leftX, player.h - 12 + step + jumpTilt + drop, player.w / 2 - 4, 12);
      ctx.fillRect(rightX, player.h - 12 - step + jumpTilt + drop, player.w / 2 - 4, 12);
      // body
      const bodyX = 8;
      const bodyY = player.h - 52;
      const bodyW = player.w - 16;
      const bodyH = 40;
      ctx.fillStyle = s.suit;
      ctx.fillRect(bodyX, bodyY, bodyW, bodyH);
      ctx.fillStyle = s.trim || "#fff";
      ctx.fillRect(bodyX, bodyY + 4, bodyW, 6);
      ctx.fillRect(bodyX, bodyY + bodyH - 8, bodyW, 6);
      ctx.fillStyle = s.belt || "#0b172a";
      ctx.fillRect(bodyX, bodyY + bodyH / 2, bodyW, 6);
      ctx.fillStyle = "#fef3c7";
      ctx.fillRect(bodyX + bodyW / 2 - 4, bodyY + bodyH / 2 + 1, 8, 4);
      // head
      const headX = 12;
      const headY = player.h - 80;
      const headW = player.w - 24;
      const headH = 26;
      ctx.fillStyle = s.head || "#f4c7a3";
      ctx.fillRect(headX, headY, headW, headH);
      // beard / braids
      if (s.beard) {
        ctx.fillStyle = s.beard;
        ctx.beginPath();
        ctx.moveTo(headX, headY + headH);
        ctx.lineTo(headX + headW / 2, headY + headH + 10);
        ctx.lineTo(headX + headW, headY + headH);
        ctx.closePath();
        ctx.fill();
      } else if (s.braids) {
        ctx.fillStyle = s.braids;
        ctx.fillRect(headX - 4, headY + 12, 6, 14);
        ctx.fillRect(headX + headW - 2, headY + 12, 6, 14);
      }
      // hat
      ctx.fillStyle = s.hat || s.suit;
      ctx.fillRect(headX, headY - 12, headW, 14);
      ctx.fillStyle = s.hatTrim || s.trim || "#fff";
      ctx.fillRect(headX, headY - 16, headW, 6);
      ctx.beginPath();
      ctx.arc(headX + headW - 6, headY - 18, 4, 0, Math.PI * 2);
      ctx.fill();
      // accessory
      if (s.bow) {
        ctx.fillStyle = s.bow;
        ctx.beginPath();
        ctx.moveTo(headX + headW - 6, headY + 6);
        ctx.lineTo(headX + headW + 6, headY + 2);
        ctx.lineTo(headX + headW + 4, headY + 14);
        ctx.closePath();
        ctx.fill();
        ctx.fillRect(headX + headW - 4, headY + 7, 6, 6);
      }
      // eyes
      ctx.fillStyle = "#1f2937";
      ctx.fillRect(player.w / 2 - 10, player.h - 70, 6, 6);
      ctx.fillRect(player.w / 2 + 4, player.h - 70, 6, 6);
      ctx.restore();

      ctx.restore();
    }

    function updatePanel() {
      const now = performance.now();
      let shown = false;
      const clearPanelTyping = () => {
        if (panelTypeTimer) { clearInterval(panelTypeTimer); panelTypeTimer = null; }
      };
      const setPanelContent = (b) => {
        const key = `${b.item.name || ""}|${b.item.note || ""}`;
        if (panelCurrentKey === key) return;
        panelCurrentKey = key;
        clearPanelTyping();
        panelText.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center;font-size:1.05rem;font-weight:700;">
            <span style="font-size:2.2rem;line-height:1;">${b.icon}</span>
            <span>${b.item.name}</span>
          </div>
          <div class="panel-note" style="color:#5f728c;font-size:0.95rem;margin:4px 0 2px;height:auto;min-height:1.4em;"></div>
        `;
        const noteEl = panelText.querySelector(".panel-note");
        const text = b.item.note || "";
        let i = 0;
        panelTypeTimer = setInterval(() => {
          noteEl.textContent = text.slice(0, i + 1);
          i++;
          if (i >= text.length) {
            clearPanelTyping();
          }
        }, 28);
      };
      boxes.forEach(b => {
        if (b.collected) return;
        const near = rectsCollide(player, b) || (Math.abs((player.x + player.w / 2) - (b.x + b.w / 2)) < 60 && Math.abs(player.y + player.h - b.y) < 80);
        if (near) {
          panel.classList.add("active");
          setPanelContent(b);
          popupUntil = now + 3600;
          shown = true;
          if (!b.collected) {
            b.collected = true;
            collected.push(b.item);
            bag.push(b.item);
          }
        }
      });
      if (shown || now < popupUntil) {
        panel.classList.add("active");
      } else {
        panel.classList.remove("active");
        panelCurrentKey = "";
        clearPanelTyping();
        panelText.innerHTML = "";
      }
    }

    function handleWindows() {
      if (!bag.length) return;
      const slot = windows.find(w => {
        if (w.item) return false;
        const dx = (player.x + player.w / 2) - (w.x + windowSize.w / 2);
        const dy = (player.y + player.h / 2) - (w.y + windowSize.h / 2);
        return Math.abs(dx) < windowSize.w && Math.abs(dy) < 140;
      });
      if (slot) {
        slot.item = bag.shift();
      }
    }

    function allWindowsFilled() {
      const filled = windows.filter(w => w.item).length;
      return windows.length > 0 && filled >= windows.length - 1; // leyfum a√∞ einn gluggi s√© au√∞ur
    }

    function updateCoverReveal() {
      if (!coverRevealActive) return;
      const delay = 220;
      const elapsed = performance.now() - coverRevealStart;
      let revealCount = Math.floor(elapsed / delay);
      if (revealCount > windows.length) revealCount = windows.length;
      for (let i = 0; i < revealCount; i++) {
        if (windows[i]) windows[i].coverShown = true;
      }
      if (revealCount >= windows.length) {
        coverRevealActive = false;
        coverRevealDone = true;
      }
    }

    function positionSantaBubble() {
      if (santaBubble.style.display === "none") return;
      const screenX = player.x - lastCameraX + player.w / 2;
      const screenY = player.y - 30;
      santaBubble.style.left = `${Math.max(20, Math.min(canvas.width - 20, screenX))}px`;
      santaBubble.style.top = `${Math.max(10, Math.min(canvas.height - 60, screenY))}px`;
      santaBubble.style.transform = "translate(-50%, -50%)";
    }

    function loop() {
      physics();
      handleWindows();
      updateCoverReveal();
      const cameraX = Math.max(0, Math.min(player.x - canvas.width / 2 + player.w / 2, world.width - canvas.width));
      lastCameraX = cameraX;
      render(cameraX);
      updatePanel();
      if (allWindowsFilled() && coverReady && !coverRevealActive && !coverRevealDone) {
        coverRevealActive = true;
        coverRevealStart = performance.now();
      }
      if (coverRevealDone && !celebrationShown) {
        celebrationShown = true;
        showCelebration();
      }
      requestAnimationFrame(loop);
    }

    function resetPlayer() {
      player.x = 80;
      player.y = 400;
      player.vx = 0;
      player.vy = 0;
      player.onGround = false;
    }

    function restartGame() {
      if (menuOverlay) {
        menuOverlay.remove();
        menuOverlay = null;
      }
      collected.length = 0;
      bag.length = 0;
      celebrationShown = false;
      if (santaTimer) { clearTimeout(santaTimer); santaTimer = null; }
      if (santaTypeTimer) { clearInterval(santaTypeTimer); santaTypeTimer = null; }
      santaBubble.style.display = "none";
      coverRevealActive = false;
      coverRevealDone = false;
      coverRevealStart = 0;
      lootList = sample(lootPool, 12);
      placeBoxes(lootList);
      setupWindows();
      panel.classList.remove("active");
      resetPlayer();
    }

    function placeBoxes(items) {
      boxes.length = 0;
      const spots = [
        { x: 220, y: 480 }, { x: 620, y: 480 }, { x: 1250, y: 440 },
        { x: 1500, y: 440 }, { x: 1850, y: 420 }, { x: 2350, y: 480 },
        { x: 2650, y: 480 }, { x: 3050, y: 420 }, { x: 3350, y: 420 },
        { x: 3600, y: 420 }, { x: 900, y: 300 }, { x: 2800, y: 320 },
      ];
      items.forEach((item, i) => {
        const spot = spots[i % spots.length];
        boxes.push({
          x: spot.x,
          y: spot.y,
          w: 80,
          h: 80,
          item,
          collected: false,
          icon: item.emoji,
        });
      });
    }

    // Skin selection rendered as grid of mini characters
    function renderSkinSelect() {
      const fragments = skins.map((s, idx) => {
        return `
          <button class="skin-option" data-idx="${idx}" aria-label="√ötlit ${idx + 1}">
            <div class="hat" style="background:${s.hat || s.suit};"></div>
            <div class="hat-trim" style="background:${s.hatTrim || s.trim || "#fff"};"></div>
            <div class="head" style="background:${s.head};"></div>
            <div class="body" style="background:${s.suit};"></div>
            <div class="foot" style="background:${s.boots || s.suit};"></div>
            ${s.beard ? `<div class="beard" style="background:${s.beard};"></div>` : ""}
            ${s.braids ? `<div class="braids" style="background:${s.braids};"></div>` : ""}
            ${s.bow ? `<div class="bow" style="background:${s.bow};"></div>` : ""}
          </button>
        `;
      }).join("");
      skinGrid.innerHTML = fragments;
      skinGrid.querySelectorAll(".skin-option").forEach(btn => {
        btn.addEventListener("click", () => {
          skinGrid.querySelectorAll(".skin-option").forEach(el => el.classList.remove("active"));
          btn.classList.add("active");
          const idx = Number(btn.dataset.idx) || 0;
          selectedSkin = skins[Math.max(0, Math.min(skins.length - 1, idx))];
        });
      });
      const first = skinGrid.querySelector(".skin-option");
      if (first) first.classList.add("active");

      function closeIntro() {
        introOverlay.style.display = "none";
        skinGrid.style.display = "none";
        toggleSkins.textContent = "Veldu j√≥lasvein";
      }

      toggleSkins.addEventListener("click", (e) => {
        e.stopPropagation();
        const visible = skinGrid.style.display !== "none";
        if (visible) {
          closeIntro();
        } else {
          skinGrid.style.display = "grid";
          toggleSkins.textContent = "Lj√∫ka vali";
        }
      });
      introOverlay.addEventListener("click", (e) => {
        if (e.target === introOverlay) {
          closeIntro();
        }
      });
      introCard.addEventListener("click", (e) => e.stopPropagation());
    }

    function showCelebration() {
      if (menuOverlay) return;
      const html = `
        <div id="menuOverlay" style="position:fixed;inset:0;background:radial-gradient(circle at 20% 20%, rgba(255,255,255,0.12), transparent 30%), radial-gradient(circle at 80% 10%, rgba(248,113,113,0.15), transparent 28%), linear-gradient(180deg, #0b1430 0%, #0f1d46 55%, #162a55 100%);display:flex;align-items:center;justify-content:center;z-index:50;">
          <div style="background:linear-gradient(180deg, rgba(255,255,255,0.96) 0%, rgba(230,242,255,0.96) 100%);border:1px solid rgba(14,165,233,0.25);border-radius:18px;padding:20px;max-width:92vw;max-height:84vh;overflow:auto;color:#0b172a;font-family:Inter, sans-serif;line-height:1.55;position:relative;box-shadow:0 22px 60px rgba(0,0,0,0.35);">
            <h2 style="margin:0 0 10px;font-size:1.7rem;color:#0f172a;">√û√∫ hefur glatt √∂ll b√∂rnin</h2>
            <p style="margin:0 0 12px;color:#1e293b;">Allir gluggarnir fylltust og allir fengu Myndars√∂gum √≠ sk√≥inn.</p>
            <div style="display:flex;justify-content:center;margin:8px 0 14px;">
              <a href="mailto:myndarsogur@gmail.com?subject=Myndars%C3%B6gur%20%C3%AD%20sk%C3%B3inn&body=H%C3%A6h%C3%A6%2C%0A%0AMig%20langar%20a%C3%B0%20f%C3%A1%20eitt%20eintak%20af%20Myndars%C3%B6gum%20%C3%AD%20sk%C3%B3inn%20hvar%20get%20%C3%A9g%20n%C3%A1lgast%20%C3%BEa%C3%B0%20og%20geti%C3%B0%20%C3%BEi%C3%B0%20komi%C3%B0%20%C3%BEv%C3%AD%20til%20m%C3%ADn%3F%0A%0ABestu%20kve%C3%B0jur" style="display:inline-block;">
                <img src="${coverSrc}" alt="Fors√≠√∞a Myndars√∂gur √≠ sk√≥inn" style="width:100%;max-width:200px;border-radius:14px;border:2px solid rgba(248,113,113,0.6);box-shadow:0 18px 36px rgba(15,23,42,0.35);image-rendering:pixelated;image-rendering:crisp-edges;" />
              </a>
            </div>
            <p style="margin:0 0 6px;color:#ef4444;font-weight:800;">√û√∫ getur l√≠ka fengi√∞ Myndars√∂gur √≠ sk√≥inn. Smelltu bara √° myndina til a√∞ panta e√∞a l√≠ttu vi√∞ √≠ n√¶stu verslun Nexus e√∞a Pennans og spur√∞u um √æ√¶r.</p>
            <p style="margin:0 0 12px;color:#0f172a;">En hver veit... kannski kemur j√≥lasveinninn me√∞ √æ√¶r til √æ√≠n.</p>
            <button id="closeMenu" style="margin-top:8px;padding:10px 14px;border:none;border-radius:10px;background:#22c55e;color:#0b0f1a;font-weight:800;cursor:pointer;">Spila aftur</button>
          </div>
        </div>
      `;
      const wrap = document.createElement("div");
      wrap.innerHTML = html;
      document.body.appendChild(wrap);
      menuOverlay = wrap;
      const close = () => restartGame();
      wrap.querySelector("#closeMenu").addEventListener("click", close, { once: true });
      wrap.addEventListener("click", (e) => { if (e.target.id === "menuOverlay") close(); });
      window.addEventListener("keydown", function onKey(e) {
        if (e.code === "Space") { e.preventDefault(); close(); window.removeEventListener("keydown", onKey); }
      });
    }

    bindControls();
    setupWindows();
    lootList = sample(lootPool, 12);
    placeBoxes(lootList);
    renderSkinSelect();
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    loop();
  </script>
</body>
</html>
